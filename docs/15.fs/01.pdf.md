PDF-Explained

### (零) Doom PDF

[https://github.com/ading2210/doompdf](https://github.com/ading2210/doompdf)

---

### （一）概述与特性

> 简介
- PDF全称：可移植文档格式（Portable Document Format）
- 描述打印页面的世界领先语言，适用于纸张和在线使用
- 确保文件在不同平台和设备上呈现一致

> 历史与发展
- 最初是Adobe的内部项目，旨在创建与平台无关的文档交换方法
- 从PostScript图形语言中衍生而来，但解决了PostScript在屏幕使用上的不实用性
- 2008年成为ISO标准化开放标准（ISO-32000-1:2008）

> 主要特性
- 随机访问与线性化：任何对象（页面、图形等）可恒定时间内访问，线性化优化Web浏览
- 流创建与增量更新：支持顺序创建大文件，增量更新实现快速保存与撤消
- 嵌入字体：确保文档字体一致性，支持多种字体格式
- 可搜索文本：维护字符形状到Unicode的映射，支持文本复制、粘贴与搜索
- 安全特性：RC4/AES加密，所有者密码与用户密码，数字签名

> 专业变体

- PDF/A：长期存档标准，要求嵌入字体、元数据，禁止加密与JavaScript
- PDF/X：印刷行业图形交换标准，要求嵌入字体与图像数据，禁止声音、电影等

---

### （二）文件结构

> [组成部分](https://zxyle.github.io/PDF-Explained/chapter4.html)
- Document Content：描述文档结构的对象（页面、元数据、字体等）
- Page Content：使用操作符将文本和图形放置在页面上的指令序列
- File Structure：文件头（Header）、交叉引用表（Xref）、文件尾（Trailer）
    - header，提供PDF版本号
    - body，包含页面、图形内容和大部分辅助信息的主体，全部编码为一系列对象。
    - 交叉引用表，列出文件中每个对象的位置便于随机访问。
    - trailer，包括trailer字典，它有助于找到文件的每个部分，并列出可以在不处理整个文件的情况下读取的各种元数据。

![](https://cdn.jsdelivr.net/gh/lvsoso/rnotes@main/img/2025-09-13-14-02-43.png)
![](https://cdn.jsdelivr.net/gh/lvsoso/rnotes@main/img/2025-09-13-14-02-58.png)

> Incremental Update（增量更新）

- 定义:
    - 增量更新允许通过将修改附加到文件末尾来更新PDF文件，而不需要重写整个文件。
- 机制:
    -  新增/修改对象: 新的或更改的对象被附加到文件末尾。
    - 更新交叉引用表: 交叉引用表被更新以反映新对象的位置。
- 优势:
    - 快速保存: 更改可以快速保存，无需重写整个文件。
    - 版本控制: 支持文档的多个版本，可以撤销更改以检索早期版本。
    - 数字签名: 更改经过数字签名的文档时，必须使用增量更新以保持签名有效性。

> Object and Cross-Reference Stream（对象和交叉引用流）
- 对象流:
    - 定义: 从PDF 1.5开始，允许多个对象放入单个对象流中，整个流被压缩。
    - 优势: 进一步压缩PDF文件，减少文件大小。
- 交叉引用流:
    - 定义: 用于引用对象流中的对象的新机制。
    - 机制: 交叉引用流替代传统的交叉引用表，提供对象位置的压缩表示。
- 压缩机制:
    - 对象分组: 将特定时间所需的对象组合在一起（例如每页的对象）。
    - 保留随机访问: 保留文档的随机访问属性，避免将所有对象放入单个对象流中。

> Linearized PDF（线性化PDF）
- 定义:
    - 线性化PDF是一种优化机制，使PDF文件在网络环境中快速显示第一页，并允许快速跳转到其他页面。
- 机制:
    - 对象排序: 添加有关如何对文件中的对象进行排序的规则。
    - 提示表: 提供如何访问对象的提示，以加速页面显示。
- 优势:
    - 快速显示: 第一页快速显示，无需等待整个文件下载。
    - 快速跳转: 通过超链接或书签快速跳转到其他页面。
    - 向后兼容: 线性化PDF文件也是正常的PDF文件，可由不理解线性化的阅读器读取。

---

### （三）最小的PDF文档

- trailer字典，提供有关如何阅读其余内容的信息文件中的对象
- 文档目录，它是对象图的根。
- 页面树，它枚举文档中的页面。
- 至少有一页。每个页面必须具有：
    - resources(资源)，包括例如字体。
    - 其页面内容，其中包含绘制文本和图形的说明在页面上。


helloword-broker.pdf:

```plaintext
%PDF-1.0    % 文件header
1 0 obj     % 主要对象
<< /Type /Pages
   /Count 1
   /Kids [2 0 R]
>>
endobj
2 0 obj
<< /Type /Page
   /MediaBox [0 0 612 792]
   /Resources 3 0 R
   /Parent 1 0 R
   /Contents [4 0 R]
>>
endobj
3 0 obj
<< /Font
     << /F0
          << /Type /Font
             /BaseFont /Times-Italic
             /Subtype /Type1 >>
     >>
>>
endobj
4 0 obj     % 图形内容
<< >>
stream
1. 0. 0. 1. 50. 700. cm
BT
 /F0 36. Tf
 (Hello, World!) Tj
ET
endstream
endobj
5 0 obj     % 目录，交叉引用表和trailer
<< /Type /Catalog
   /Pages 1 0 R
>>
endobj
xref
0 6
trailer
<< /Size 6
   /Root 5 0 R
>>
startxref
0
%%EOF
```

可以直接打开查看

![](https://cdn.jsdelivr.net/gh/lvsoso/rnotes@main/img/2025-09-13-13-54-05.png)

---

### （四）加密

> 核心特点
- 加密范围：仅加密流和字符串内容，不加密数字或PDF结构
- 结构可见性：文档对象结构保持可见，内容得到保护
- 元数据处理：现代方法允许XMP元数据保持未加密状态

> 发展历程
- PDF 1.1：引入40位RC4加密
- PDF 1.4：128位RC4加密
- PDF 1.5：128位AES加密
- PDF 1.7：256位AES加密

#### 加密字段结构

关键条目
```shell
├── /R, /V：定义加密算法
├── /P：权限位域（打印、修改、提取等）
├── /O：所有者密码验证
├── /U：用户密码验证
└── /Filter：安全方法标准
```
双密码体系

- 所有者密码：完全控制权限，可修改安全设置
- 用户密码：受限权限，由所有者定义
- 空白用户密码：常见做法，文件直接打开但功能受限

#### 加密解密流程

读取加密文件
- 解析对象图（无需解密）
- 检查/Encrypt条目确认加密状态
- 验证用户密码（单向算法）
- 计算解密密钥
- 解密流和字符串
- 强制执行权限设置

写入加密文件
- 计算/U和/O条目（单向算法）
- 构建加密字典并添加到trailer
- 使用密钥加密所有字符串和流
- 展平对象图为文件

#### 权限
权限类型
- 查看文档
- 打印文档
- 修改内容
- 提取文本和图形
- 添加注释

权限特性
- 40位RC4：基础权限组合
- 128位及以上：扩展权限选项
- 实现差异：不同PDF处理器可能有不同解释

#### 注意

- 编辑加密文档仅有用户密码时需要保持原加密设置
- 编辑加密文档解密后需删除加密字典或者使用相同密码重新加密

---

### （五）浏览器预览和优化

> pdf.js
- Mozilla开发的开源JavaScript库
- 在Web浏览器中渲染PDF文件，无需插件
- 支持大部分PDF特性，包括文本、图像、注释等


手动翻页

![](https://cdn.jsdelivr.net/gh/lvsoso/rnotes@main/img/2025-09-13-16-28-09.png)

滚动翻页

![](https://cdn.jsdelivr.net/gh/lvsoso/rnotes@main/img/2025-09-13-16-32-46.png)


> pdf -> 图片
- 转成多页图片
- 需要前端支持
- 无法复制文字

---

### （六）参考资料

- [PDF-Explained](https://zxyle.github.io/PDF-Explained/)

- [PDF.js API 文档](https://mozilla.github.io/pdf.js/getting_started/#api)

- [vue3实现高性能pdf预览器功能可行性方案及实践（pdfjs-dist5.x插件使用及自定义修改）](https://juejin.cn/post/7529439907820797988)

- [002-Vue项目中通过pdfjs实现PDF预览](https://www.cnblogs.com/suifengxiaoyao1990/articles/16133529.html)

- [如何实现高性能的在线 PDF 预览](https://www.infoq.cn/article/lcz5uvnlme1dsymtipkq)

- [从生产事故分析背后的渲染瓶颈](https://juejin.cn/post/6932797926120882190)